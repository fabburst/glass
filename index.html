<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyRadar - Real Data Only</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        /* Glassmorphism plus poussé "Pixel Style" */
        .glass-panel { background: rgba(255, 255, 255, 0.90); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.5); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'm3-primary': '#006492',
                        'm3-on-surface': '#191c1e',
                        'm3-surface-variant': '#e1e2e8',
                    },
                    borderRadius: { '4xl': '32px' }
                }
            }
        }
    </script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- WIDGET : INDICATEUR DE MONTÉE/DESCENTE (Vario) ---
    const VarioWidget = ({ rate }) => {
        // rate est en m/s. 
        const isClimbing = rate > 0.5;
        const isDescending = rate < -0.5;
        const isCruise = !isClimbing && !isDescending;

        let icon = "minus";
        let color = "text-slate-500";
        let bg = "bg-slate-100";
        let label = "En croisière";

        if (isClimbing) {
            icon = "trending-up"; color = "text-emerald-600"; bg = "bg-emerald-50"; label = "En montée";
        } else if (isDescending) {
            icon = "trending-down"; color = "text-amber-600"; bg = "bg-amber-50"; label = "En descente";
        }

        return (
            <div className={`p-4 rounded-3xl border border-white/50 shadow-sm flex flex-col justify-between h-28 ${bg}`}>
                <div className="flex justify-between items-start">
                    <span className={`text-[10px] font-bold uppercase tracking-wider ${color}`}>{label}</span>
                    <i data-lucide={icon} className={`w-5 h-5 ${color}`}></i>
                </div>
                <div>
                    <div className={`text-2xl font-black ${color}`}>
                        {Math.abs(rate).toFixed(1)} <span className="text-sm font-medium opacity-70">m/s</span>
                    </div>
                </div>
            </div>
        );
    };

    const App = () => {
        const [planes, setPlanes] = useState([]);
        const [loading, setLoading] = useState(false);
        const [hasLocated, setHasLocated] = useState(false);
        const [selectedPlane, setSelectedPlane] = useState(null);
        const [planeDetails, setPlaneDetails] = useState(null);

        const mapRef = useRef(null);
        const userMarkerRef = useRef(null);
        const planesLayerRef = useRef(L.layerGroup());

        // Récupération Photo (Uniquement si dispo)
        const fetchPlanePhoto = async (icaoHex) => {
            setPlaneDetails(null);
            try {
                const res = await fetch(`https://api.planespotters.net/pub/photos/hex/${icaoHex}`);
                const data = await res.json();
                if (data.photos?.length > 0) {
                    setPlaneDetails({
                        photo: data.photos[0].thumbnail_large.src,
                        reg: data.photos[0].reg,
                        type: data.photos[0].plane_type,
                        airline: data.photos[0].airline
                    });
                }
            } catch (err) { /* Silent fail */ } 
        };

        useEffect(() => {
            if (!mapRef.current) {
                mapRef.current = L.map('map', { zoomControl: false, attributionControl: false }).setView([46.22, 2.21], 5);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(mapRef.current);
                planesLayerRef.current.addTo(mapRef.current);
            }
            lucide.createIcons();
        }, []);

        useEffect(() => { if(selectedPlane) fetchPlanePhoto(selectedPlane.id); }, [selectedPlane]);

        const startTracking = () => {
            if (!navigator.geolocation) return;
            setLoading(true);

            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                mapRef.current.setView([latitude, longitude], 11);
                
                if (userMarkerRef.current) mapRef.current.removeLayer(userMarkerRef.current);
                const userIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:#006492; width:20px; height:20px; border-radius:50%; border:4px solid white; box-shadow:0 4px 15px rgba(0,100,146,0.4);"></div>`,
                    iconSize: [24, 24]
                });
                userMarkerRef.current = L.marker([latitude, longitude], {icon: userIcon}).addTo(mapRef.current);
                setHasLocated(true);

                fetch(`/api/glass?lat=${latitude}&lon=${longitude}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data || !data.states) { setPlanes([]); setLoading(false); return; }

                        const cleanPlanes = data.states
                            .filter(d => d[5] && d[6])
                            .map(d => ({
                                id: d[0], callsign: d[1].trim() || "N/A", country: d[2],
                                lon: d[5], lat: d[6], altitude: d[7] || 0, velocity: d[9] || 0, heading: d[10] || 0,
                                vertical_rate: d[11] || 0, // VRAIE DONNÉE OPENSKY
                                on_ground: d[8] || false
                            }));

                        setPlanes(cleanPlanes);
                        planesLayerRef.current.clearLayers();
                        
                        cleanPlanes.forEach(plane => {
                            // Style Avion
                            const svg = `
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${plane.on_ground ? '#64748b' : '#006492'}" stroke="white" stroke-width="1.5" style="transform: rotate(${plane.heading}deg); filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.2));">
                                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                                </svg>`;

                            const icon = L.divIcon({ html: svg, className: '', iconSize: [36, 36], iconAnchor: [18, 18] });

                            L.marker([plane.lat, plane.lon], {icon: icon})
                                .on('click', () => { setSelectedPlane(plane); mapRef.current.panTo([plane.lat, plane.lon]); })
                                .addTo(planesLayerRef.current);
                        });
                        setLoading(false);
                    })
                    .catch(() => setLoading(false));
            }, () => setLoading(false));
        };

        return (
            <div className="relative h-screen w-full font-sans text-slate-800">
                <div id="map"></div>
                
                {hasLocated && (
                    <div className="absolute top-12 left-0 right-0 z-[1000] flex justify-center pointer-events-none">
                        <div className="glass-panel px-6 py-3 rounded-full flex items-center gap-3 shadow-lg animate-in fade-in slide-in-from-top-4">
                            <div className={`w-2.5 h-2.5 rounded-full ${loading ? 'bg-m3-primary animate-ping' : 'bg-emerald-500'}`}></div>
                            <span className="text-sm font-bold tracking-tight">{planes.length} appareils détectés</span>
                        </div>
                    </div>
                )}

                <div className="absolute inset-x-0 bottom-0 z-[1001] p-4 pointer-events-none flex flex-col justify-end h-full">
                    {!selectedPlane && (
                        <div className="flex justify-end mb-6 pointer-events-auto">
                            <button onClick={startTracking} className="bg-m3-primary text-white h-16 w-16 rounded-[24px] shadow-xl flex items-center justify-center hover:scale-105 active:scale-95 transition-all ring-4 ring-white/30">
                                <i data-lucide={loading ? "loader-2" : "radar"} className={loading ? "animate-spin w-8 h-8" : "w-8 h-8"}></i>
                            </button>
                        </div>
                    )}

                    <div className={`card glass-panel w-full max-w-lg mx-auto pointer-events-auto transition-all duration-500 cubic-bezier(0.4, 0, 0.2, 1) ${selectedPlane ? 'translate-y-0 opacity-100' : 'translate-y-[120%] opacity-0'} rounded-[36px] mb-2 shadow-2xl overflow-hidden`}>
                        {selectedPlane && (
                            <div className="p-0 pb-6 relative">
                                <button onClick={()=>setSelectedPlane(null)} className="absolute top-4 right-4 z-20 bg-black/10 backdrop-blur-md p-2 rounded-full text-slate-700 hover:bg-black/20">
                                    <i data-lucide="x" className="w-5 h-5"></i>
                                </button>

                                {/* Photo Conditionnelle (Disparaît si absente) */}
                                {planeDetails?.photo && (
                                    <div className="relative w-full h-48">
                                        <img src={planeDetails.photo} className="w-full h-full object-cover" alt="Avion" />
                                        <div className="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent"></div>
                                    </div>
                                )}

                                <div className={`px-6 ${!planeDetails?.photo ? 'pt-8' : ''}`}>
                                    {/* Header Info */}
                                    <div className="mb-6">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="bg-m3-surface-variant text-slate-600 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest">{selectedPlane.country}</span>
                                            <span className="text-slate-400 text-xs font-mono">{selectedPlane.id}</span>
                                        </div>
                                        <h2 className="text-4xl font-[850] text-m3-on-surface tracking-tighter leading-none">{selectedPlane.callsign}</h2>
                                        <p className="text-m3-primary font-bold text-sm mt-1">{planeDetails?.airline || "Opérateur privé / Inconnu"}</p>
                                    </div>

                                    {/* Grille de Widgets (Bento Grid Style) */}
                                    <div className="grid grid-cols-2 gap-3">
                                        
                                        {/* Widget 1 : Altitude */}
                                        <div className="p-4 rounded-3xl bg-white border border-slate-100 shadow-sm flex flex-col justify-between h-28">
                                            <div className="flex justify-between items-start">
                                                <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Altitude</span>
                                                <i data-lucide="arrow-up" className="w-5 h-5 text-m3-primary"></i>
                                            </div>
                                            <div>
                                                <div className="text-2xl font-black text-slate-800">
                                                    {Math.round(selectedPlane.altitude)} <span className="text-sm font-medium text-slate-400">m</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Widget 2 : Vitesse */}
                                        <div className="p-4 rounded-3xl bg-white border border-slate-100 shadow-sm flex flex-col justify-between h-28">
                                            <div className="flex justify-between items-start">
                                                <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Vitesse Sol</span>
                                                <i data-lucide="zap" className="w-5 h-5 text-orange-500"></i>
                                            </div>
                                            <div>
                                                <div className="text-2xl font-black text-slate-800">
                                                    {Math.round(selectedPlane.velocity * 3.6)} <span className="text-sm font-medium text-slate-400">km/h</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Widget 3 : Vario (Nouveau & Réel) */}
                                        <VarioWidget rate={selectedPlane.vertical_rate} />

                                        {/* Widget 4 : Cap & Modèle */}
                                        <div className="p-4 rounded-3xl bg-slate-800 text-white shadow-sm flex flex-col justify-between h-28">
                                            <div className="flex justify-between items-start">
                                                <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Cap</span>
                                                <i data-lucide="compass" className="w-5 h-5 text-slate-300"></i>
                                            </div>
                                            <div className="flex items-end justify-between">
                                                <div className="text-2xl font-black">
                                                    {Math.round(selectedPlane.heading)}°
                                                </div>
                                                <div className="text-[10px] text-slate-400 font-medium max-w-[60px] truncate text-right">
                                                    {planeDetails?.type || "Type Inconnu"}
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
