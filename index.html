<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyRadar - 100% Réel</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.6); }
        .card-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .emergency-pulse { animation: pulse-red 1.5s infinite; border-radius: 50%; }
        .init-loader { position: fixed; inset: 0; z-index: 5000; background: #f0f4f8; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .hide-loader { opacity: 0; pointer-events: none; }
    </style>
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'm3-primary': '#006492', 'm3-on-surface': '#191c1e', 'm3-surface-variant': '#e1e2e8' }, borderRadius: { '4xl': '32px' } } }
        }
    </script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const getAirlineName = (callsign) => {
        if (!callsign || callsign.length < 3) return "Aviation Générale";
        const code = callsign.substring(0, 3).toUpperCase();
        const airlines = { 'AFR': 'Air France', 'EZY': 'EasyJet', 'RYR': 'Ryanair', 'BAW': 'British Airways', 'DLH': 'Lufthansa', 'KLM': 'KLM', 'VLG': 'Vueling', 'TVF': 'Transavia', 'SAM': 'SAMU', 'SEC': 'Sécurité Civile' };
        return airlines[code] || `Compagnie ${code}`;
    };

    const VarioWidget = ({ rate }) => {
        const isClimbing = rate > 0.5; const isDescending = rate < -0.5;
        let icon = "minus"; let color = "text-slate-500"; let bg = "bg-slate-50"; let label = "En Croisière";
        if (isClimbing) { icon = "trending-up"; color = "text-emerald-600"; bg = "bg-emerald-50"; label = "Ascension"; } 
        else if (isDescending) { icon = "trending-down"; color = "text-amber-600"; bg = "bg-amber-50"; label = "Descente"; }
        return (
            <div className={`p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col justify-between h-28 ${bg}`}>
                <div className="flex justify-between items-start"><span className={`text-[10px] font-bold uppercase tracking-wider ${color}`}>{label}</span><i data-lucide={icon} className={`w-5 h-5 ${color}`}></i></div>
                <div><div className={`text-2xl font-black ${color}`}>{Math.abs(rate).toFixed(1)} <span className="text-sm font-medium opacity-70">m/s</span></div><div className="text-[10px] text-slate-400 font-medium">Vitesse Verticale</div></div>
            </div>
        );
    };

    const App = () => {
        const [planes, setPlanes] = useState([]);
        const [selectedPlane, setSelectedPlane] = useState(null);
        const [planeDetails, setPlaneDetails] = useState(null);
        const [initPhase, setInitPhase] = useState(true);
        const [loading, setLoading] = useState(false);
        const [gpsError, setGpsError] = useState(false);
        
        // NOUVEL ÉTAT : Erreur API
        const [apiError, setApiError] = useState(false);

        const mapRef = useRef(null);
        const userMarkerRef = useRef(null);
        const planesLayerRef = useRef(L.layerGroup());
        const debounceRef = useRef(null);

        const fetchPlanes = (params) => {
            setLoading(true);
            setApiError(false); // On reset l'erreur avant de chercher

            fetch(`/api/glass?${params}`)
                .then(res => {
                    // Si le backend renvoie 500 ou 502, c'est une erreur
                    if (!res.ok) throw new Error("Erreur Backend");
                    return res.json();
                })
                .then(data => {
                    if (!data || !data.states) { 
                        // Pas d'avions, mais pas d'erreur technique
                        setPlanes([]); 
                        setLoading(false); 
                        // On vide la carte
                        planesLayerRef.current.clearLayers();
                        return; 
                    }

                    const cleanPlanes = data.states.filter(d => d[5] && d[6]).map(d => ({
                        id: d[0], callsign: d[1].trim() || "N/A", country: d[2],
                        lon: d[5], lat: d[6], altitude: d[7] || 0, velocity: d[9] || 0, heading: d[10] || 0,
                        vertical_rate: d[11] || 0, on_ground: d[8] || false, category: d[17] || 0, squawk: d[6] || null, last_contact: d[4] || 0
                    }));
                    
                    setPlanes(cleanPlanes);
                    planesLayerRef.current.clearLayers();
                    
                    cleanPlanes.forEach(plane => {
                        const isHeli = plane.category === 7;
                        const isEmergency = plane.squawk === "7700";
                        const baseColor = isEmergency ? '#ef4444' : (plane.on_ground ? '#64748b' : '#006492');
                        const path = isHeli 
                            ? `<path d="M12 4L3 9v2h18V9L12 4z M10 11v3H5v2h5v3.5l-2 1.5V22h8v-1l-2-1.5V16h5v-2h-5v-3H10z" />`
                            : `<path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>`;
                        
                        const html = isEmergency 
                            ? `<div class="emergency-pulse w-full h-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${baseColor}" stroke="white" stroke-width="1.5" style="transform: rotate(${plane.heading}deg);">${path}</svg></div>`
                            : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${baseColor}" stroke="white" stroke-width="1.5" style="transform: rotate(${plane.heading}deg); filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3));">${path}</svg>`;

                        const icon = L.divIcon({ html: html, className: '', iconSize: [40, 40], iconAnchor: [20, 20] });
                        L.marker([plane.lat, plane.lon], {icon: icon}).on('click', (e) => { L.DomEvent.stopPropagation(e); setSelectedPlane(plane); }).addTo(planesLayerRef.current);
                    });
                    setLoading(false);
                })
                .catch((err) => {
                    console.error(err);
                    setLoading(false);
                    setApiError(true); // Déclenche le badge rouge
                    setPlanes([]); // On vide la liste car on ne sait pas ce qui est vrai
                });
        };

        useEffect(() => {
            if (mapRef.current) return;
            navigator.geolocation.getCurrentPosition(
                (pos) => { const { latitude, longitude } = pos.coords; initMap(latitude, longitude, true); },
                (err) => { setGpsError(true); initMap(46.22, 2.21, false); },
                { enableHighAccuracy: true, timeout: 5000 }
            );

            const initMap = (lat, lon, isUserLocation) => {
                const zoomLevel = isUserLocation ? 11 : 6;
                mapRef.current = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lon], zoomLevel);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(mapRef.current);
                planesLayerRef.current.addTo(mapRef.current);
                mapRef.current.on('click', () => setSelectedPlane(null));

                if (isUserLocation) {
                    const userIcon = L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:#006492; width:20px; height:20px; border-radius:50%; border:4px solid white; box-shadow:0 4px 15px rgba(0,100,146,0.4);"></div>`, iconSize: [24, 24] });
                    userMarkerRef.current = L.marker([lat, lon], {icon: userIcon}).addTo(mapRef.current);
                    fetchPlanes(`lat=${lat}&lon=${lon}`);
                }

                mapRef.current.on('moveend', () => {
                    if (debounceRef.current) clearTimeout(debounceRef.current);
                    debounceRef.current = setTimeout(() => {
                        const b = mapRef.current.getBounds();
                        fetchPlanes(`lamin=${b.getSouth()}&lomin=${b.getWest()}&lamax=${b.getNorth()}&lomax=${b.getEast()}`);
                    }, 800);
                });
                setTimeout(() => setInitPhase(false), 500);
                lucide.createIcons();
            };
        }, []);

        useEffect(() => { if(selectedPlane) { /* fetch photo */ } }, [selectedPlane]);
        const retryGps = () => { window.location.reload(); };
        const displayAirline = getAirlineName(selectedPlane?.callsign);
        const getSignalAge = (ts) => { const diff = Math.floor(Date.now()/1000) - ts; return diff < 0 ? 0 : diff; };

        return (
            <div className="relative h-screen w-full font-sans text-slate-800">
                <div className={`init-loader ${!initPhase ? 'hide-loader' : ''}`}>
                    <div className="w-12 h-12 border-4 border-m3-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-m3-primary font-bold animate-pulse">Localisation...</p>
                </div>

                <div id="map"></div>
                
                <div className="absolute top-12 left-0 right-0 z-[1000] flex flex-col items-center gap-2 pointer-events-none">
                    
                    {/* CAS 1 : TOUT VA BIEN */}
                    {!apiError && (
                        <div className="glass-panel px-6 py-3 rounded-full flex items-center gap-3 shadow-lg animate-in fade-in slide-in-from-top-4">
                            <div className={`w-2.5 h-2.5 rounded-full ${loading ? 'bg-m3-primary animate-ping' : 'bg-emerald-500'}`}></div>
                            <span className="text-sm font-bold tracking-tight">
                                {loading ? "Recherche radar..." : `${planes.length} appareils`}
                            </span>
                        </div>
                    )}

                    {/* CAS 2 : ERREUR API (Limites OpenSky) */}
                    {apiError && (
                        <div className="bg-red-500 text-white px-6 py-3 rounded-full flex items-center gap-3 shadow-xl animate-bounce">
                            <i data-lucide="wifi-off" className="w-4 h-4"></i>
                            <span className="text-sm font-bold">Signal Radar Perdu (API Saturée)</span>
                        </div>
                    )}
                </div>

                <div className="absolute inset-x-0 bottom-0 z-[1001] p-4 pointer-events-none flex flex-col justify-end h-full">
                    {gpsError && !selectedPlane && (
                        <div className="flex justify-end mb-6 pointer-events-auto">
                            <button onClick={retryGps} className="bg-red-500 text-white px-4 py-3 rounded-2xl shadow-xl flex items-center gap-2 font-bold hover:scale-105 transition-all">
                                <i data-lucide="map-pin-off" className="w-5 h-5"></i> Réessayer GPS
                            </button>
                        </div>
                    )}

                    <div className={`card glass-panel w-full max-w-lg mx-auto pointer-events-auto transition-all duration-300 card-enter ${selectedPlane ? 'translate-y-0 opacity-100' : 'translate-y-[120%] opacity-0'} rounded-[36px] mb-2 shadow-2xl overflow-hidden cursor-pointer active:scale-[0.98]`} onClick={() => setSelectedPlane(null)}>
                        {selectedPlane && (
                            <div className="p-0 pb-6 relative">
                                <div className="absolute top-4 right-4 z-20 bg-white/50 backdrop-blur-md p-2 rounded-full text-slate-800 hover:bg-white shadow-sm"><i data-lucide="x" className="w-6 h-6"></i></div>
                                <div className="px-6 pt-8">
                                    <div className="mb-6">
                                        <div className="flex items-center justify-between mb-1">
                                            <div className="flex items-center gap-2">
                                                <span className="bg-m3-surface-variant text-slate-600 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest">{selectedPlane.country}</span>
                                                {selectedPlane.squawk === "7700" && <span className="bg-red-500 text-white px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest animate-pulse">URGENCE 7700</span>}
                                            </div>
                                            <div className="flex items-center gap-1 text-[10px] font-bold text-slate-400"><i data-lucide="signal" className="w-3 h-3"></i><span>{getSignalAge(selectedPlane.last_contact)}s</span></div>
                                        </div>
                                        <h2 className="text-4xl font-[850] text-m3-on-surface tracking-tighter leading-none">{selectedPlane.callsign}</h2>
                                        <p className="text-m3-primary font-bold text-sm mt-1 flex items-center gap-1">{displayAirline}</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3" onClick={(e) => e.stopPropagation()}> 
                                        <div className="p-4 rounded-3xl bg-white border border-slate-100 shadow-sm flex flex-col justify-between h-28">
                                            <div className="flex justify-between items-start"><span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Altitude</span><i data-lucide="arrow-up" className="w-5 h-5 text-m3-primary"></i></div>
                                            <div className="text-2xl font-black text-slate-800">{Math.round(selectedPlane.altitude)} <span className="text-sm font-medium text-slate-400">m</span></div>
                                        </div>
                                        <div className="p-4 rounded-3xl bg-white border border-slate-100 shadow-sm flex flex-col justify-between h-28">
                                            <div className="flex justify-between items-start"><span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Vitesse Sol</span><i data-lucide="zap" className="w-5 h-5 text-orange-500"></i></div>
                                            <div className="text-2xl font-black text-slate-800">{Math.round(selectedPlane.velocity * 3.6)} <span className="text-sm font-medium text-slate-400">km/h</span></div>
                                        </div>
                                        <VarioWidget rate={selectedPlane.vertical_rate} />
                                        <div className="p-4 rounded-3xl bg-slate-800 text-white shadow-sm flex flex-col justify-between h-28">
                                            <div className="flex justify-between items-start"><span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Cap</span><i data-lucide="compass" className="w-5 h-5 text-slate-300"></i></div>
                                            <div className="flex items-end justify-between">
                                                <div className="text-2xl font-black">{Math.round(selectedPlane.heading)}°</div>
                                                <div className="text-[10px] text-slate-400 font-medium max-w-[60px] truncate text-right">{selectedPlane.category === 7 ? "Hélico" : "Standard"}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <p className="text-center text-xs text-slate-300 mt-4 font-medium uppercase tracking-widest pb-2">Appuyez pour fermer</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
